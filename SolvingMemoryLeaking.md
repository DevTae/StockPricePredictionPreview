### 주식 가격 예측 모델 개발 일지 (메모리 누수 문제 해결 시도)

### 2023.8.29

#### 현재 진행 상황
  - 학습 도중에 생기는 `멈춤 현상` 을 해결하기 위하여 `해시 함수`를 활용하여 `Disk I/O` 를 줄이고자 한다.
    - 현재, 데이터 추출 방식을 동일한 raw data 에서 반복적으로 읽는 방법으로 진행하고 있는데, 이러한 구조 때문인지 학습 도중 1 step 이 이전의 1000 배의 시간이 걸리는 현상이 발생하었다. 그 이후, 프로그램이 종료되었다.
    - `num_workers` 가 4 로 설정되어 있었고, 디버깅해보았을 때 `CUDA Out of Memory` 등의 오류가 발생하지 않았다는 점에서 동일한 파일에 대한 여러 번의 접근으로 인한 `Deadlock` 발생에 대한 의심을 하는 중이다.
    - 이러한 상황에서 가장 먼저 해볼 목표는 `해시 함수`를 활용하여 `Disk I/O` 를 줄이는 것이다.

      ![image](https://github.com/DevTae/StockPricePredictionPreview/assets/55177359/598338d9-e678-49ef-945d-8c0a9a79b39a)
    - 그 결과, 성공적으로 다음과 같이 초반에 데이터를 읽어들인 이후에는 메모리에서 가져오기 때문에 성공적으로 `Disk I/O` 를 줄일 수 있었고, 그에 따라 평균 소요 시간도 `약 75% 가량 절감`할 수 있었다.
  - 위와 같이 `Disk I/O` 를 줄였음에도 학습 진행 중 똑같이 `멈춤 현상`이 발생하였고, 추가적으로 `Memory Leak` 현상이 의심되어 매 반복문에서 할당되는 `torch`, `cpu` 변수를 해제하도록 하였다.

<br/>

### 2023.8.31

#### 현재 진행 상황
  - `torch` 의 `to` 메소드에 대하여, 원래의 `torch` 값이 소실되는 우려를 바탕으로 `clone` 으로 `cpu` 에 복제 후 평가지표 계산하는 데에 쓰이도록 변경하였다.
    - (23.9.2) 해당 부분에 대하여, `torch` 값을 `cpu` 에 복제하지 않은 상태에서 사용하고 `del` 로 초기화해주는 방식으로 변경하였다.

<br/>

### 2023.9.1

#### 현재 진행 상황
  - 이전에 학습 중 생긴 `멈춤 현상`이 `Deadlock` 때문이라고 판단하였었지만 추가적인 원인으로 `CPU 할당률`이 100% 가 넘는 것을 의심하였고 설정 변경을 시도하였다.
    - `num_threads` 를 `4 -> 1` 으로 수정하였고, CPU 할당률을 자동으로 조절할 수 있도록 하였다.
  - 위 방법들을 확인해보았지만 문제는 해결되지 않았고, `Linux` 의 `dmesg -T --level err` 명령어를 바탕으로 에러에 대한 원인을 찾을 수 있었다.

    ![화면 캡처 2023-09-01 235603](https://github.com/DevTae/StockPricePredictionPreview/assets/55177359/2e18b98a-8ae3-4a3a-b618-eba4ee8e7e85)
    - 결국에는 `Out of memory` 및 `Memory Leaking` 으로 인하여 생긴 문제였고, 이에 대하여 `메모리 최적화`, `스왑 공간 확인` 등의 방법을 바탕으로 해결할 예정이다.
  - 종료 원인을 찾기 위하여 `psutil` 라이브러리를 통한 `메모리 사용량 디버깅`을 진행하고자 한다.
    - 로그 출력에 메모리 사용량(Memory Usage) 또한 출력하게 하여 확인해본 결과, 메모리 사용량이 계속해서 늘어나는 현상이 발견되었다.

      ![image](https://github.com/DevTae/StockPricePredictionPreview/assets/55177359/a34ba749-e967-448a-a7f1-320e3cb2a906)
    - 해당 현상에 대한 원인을 계속해서 찾고자 한다.

<br/>

### 2023.9.2

#### 현재 진행 상황
  - 캐시 적용 유무에 따라 메모리 변동이 다르기에 `각 100 steps` 별로 `캐시를 적용한 것`과 `적용하지 않은 것` 사이에서 비교(`psutil` 라이브러리 활용)를 진행해보았다.

    ![제목 없음](https://github.com/DevTae/StockPricePredictionPreview/assets/55177359/05cd8c98-b0b6-4b9d-af6f-654bcd791efd)
    - 그 결과, `캐시를 적용한 것`은 `Memory Usage` 측면에서 처음부터 계속 상승하고, `캐시를 적용하지 않은 것`은 처음엔 상승하지 않는 것처럼 보이다가 중간부터 계속해서 늘어나는 것을 볼 수가 있었다.
    - 결국에는, `Memory Leaking` 현상이 일어났다는 것이고 조금 더 세밀한 실험이 필요했다.
  - 그에 따라, 메모리 동향을 `guppy3` 라이브러리를 통하여 `각 100 steps` 별로 확인해보았다.
  
    ![23 9 2](https://github.com/DevTae/StockPricePredictionPreview/assets/55177359/d2ac1aa0-d4a4-4d42-bdee-caf0f031b037)
    - 중간 단계에서부터 `list`, `str`, `tuple`, `int`, `float` 등의 변수들을 바탕으로 산정해보았을 때, 별다른 메모리의 변동은 없었다.
    - 하지만, CPU 점유 메모리는 계속해서 늘어나는 상황이었다.
  - 결과적으로, 위 단서를 바탕으로 생각해볼 수 있는 가설은 다음과 같았다.
    - `guppy3` 는 `torch` 변수에 대한 크기를 반영하지 않기 때문에, 어디에선가의 `torch` 변수에 의해 `Memory Leaking` 현상이 일어나고 있다.
    - `Garbage Collector (GC)` 가 정상 작동하지 않고 있다.
  - 계속해서 문제를 해결하기 위해 추가적으로 조사할 예정이다.

<br/>

### 2023.09.03

#### 현재 진행 상황
  - `Memory Leaking` 현상의 원인을 찾을 때 `tracemalloc` 라이브러리가 어떤 라인에서 메모리가 쌓이는지 볼 수 있다고 하여 해당 라이브러리를 사용하여 문제를 해결하고 있는 중이다.
    - 우선, 해시 테이블 캐시를 제거한 상태에서의 `Memory Leaking` 현상을 분석해보았다.

    ![2023-09-04 metrics 문제 확인](https://github.com/DevTae/StockPricePredictionPreview/assets/55177359/f0dbfb02-3307-4206-b7d3-e65e03f3a860)
    - 그 결과, 평가 지표를 계산하는 부분의 `abs` 함수에서 메모리가 누수되고 있는 현상을 발견하였다.
    - 해당 부분을 파이썬의 `삼항 연산자`로 대체하였고, 평가 지표 계산하는 부분의 메모리 누수를 해결할 수 있었다.
      - `dist = (target[0] - y_hat[0] if target[0] > y_hat[0] else y_hat[0] - target[0])`
      - 캐시 기능 없이는 `Memory Leaking` 현상 없이 정상적으로 동작하고 있다.
      - 다시 캐시를 적용한 뒤에 학습을 돌렸을 때 아직도 `Memory Leaking` 현상이 의심되는 `Memory Usage` 동향이 발견되었다.
      - 캐시 적용으로 `75%` 가 넘는 학습 시간을 단축할 수 있기에 해당 문제를 해결하고자 한다.
    - 이에 따른 원인을 계속해서 분석하고 해결할 예정이다.
   
<br/>

### 2023.09.04

#### 현재 진행 상황
  - `tracemalloc` 으로 확인해보았을 때, `abs` 에 대한 메모리 누수를 해결한 후부터 아래 그림처럼 눈에 띄는 메모리 누수의 경우 발견되지 않았다.

    ![문제 없음 발견](https://github.com/DevTae/StockPricePredictionPreview/assets/55177359/fb440ed8-11ee-45ec-95a1-01ed7a48ef67)
  - 하지만, `garbage collector` 라이브러리를 통하여 직접 확인해보았을 때, 아래 그림처럼 가비지 콜렉터의 `2 세대` 에 대한 메모리가 누적됨을 발견하였다.

    ![gc 작동 중 2세대 계속 증가](https://github.com/DevTae/StockPricePredictionPreview/assets/55177359/467c4508-c13b-4fb2-a420-05cf53328ce2)
  
<br/>

### 2023.09.19

#### 현재 진행 상황
  - `캐시 유무에 따른 메모리 동향`을 재확인하고자 캐시 사용 여부를 설정으로 변경할 수 있게 하고 일단은 `캐시를 비활성화`하여 학습을 시작하였음.
    - 한 가지 의문이 생기는 점은 `멈춤 현상`을 해결하기 위해 `캐시 기능`을 적용하였는데, 정말 원인이 `캐시 기능` 떄문일지에 대한 의구심임.
    - `캐시 기능을 비활성화`하여도 똑같이 메모리 누수가 발생하는 것을 발견하였음.

<br/>

### 2024.01.22

#### 현재 진행 상황
  - 데이터 전처리 때의 피쳐 개수가 너무 많아서 줄였더니 학습 중 메모리가 급증하는 현상이 줄어들었다.
  - 이러한 점을 바탕으로, 캐시 기능을 제외하고 메모리 급증하는 문제를 해결할 수 있었다.

<br/>
